@page
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@model web_test.Pages.IndexModel

@{
    ViewData["Title"] = "Главная страница";
    Layout = "_Layout.cshtml";
}

<div class="container-fluid">
    <!-- Шапка: подразделение, пользователь, фильтры -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex flex-wrap align-items-center justify-content-between bg-light p-3 rounded">
                <div>
                    <h5 class="mb-0">Подразделение: @Model.DepartmentName</h5>
                    <p class="text-muted mb-0">Текущий пользователь: @Model.UserName</p>
                </div>

                <!-- Форма с фильтрами -->
                <form method="get" id="filterForm" class="d-flex flex-wrap align-items-end gap-2">
                    <!-- Фильтр по датам -->
                    <div class="d-flex flex-column">
                        <label for="startDate" class="form-label">C даты:</label>
                        <input type="date" class="form-control" id="startDate" name="StartDate"
                               value="@(Model.StartDate.HasValue ? Model.StartDate.Value.ToString("yyyy-MM-dd") : null)" />
                    </div>
                    <div class="d-flex flex-column">
                        <label for="endDate" class="form-label">по дату:</label>
                        <input type="date" class="form-control" id="endDate" name="EndDate"
                               value="@(Model.EndDate.HasValue ? Model.EndDate.Value.ToString("yyyy-MM-dd") : null)" />
                    </div>

                    <!-- Выпадающий список для выбора исполнителя -->
                    <div class="d-flex flex-column">
                        <label for="executor" class="form-label">Исполнитель:</label>
                        <select id="executor" name="executor" class="form-select">
                            <option value="">Все исполнители</option>
                            @foreach (var item in Model.Executors)
                            {
                                <option value="@item.Value" selected="@(item.Value == Model.executor)">@item.Value</option>
                            }
                        </select>
                    </div>

                    <!-- Строка поиска -->
                    <div class="d-flex flex-column">
                        <label for="search" class="form-label">Поиск:</label>
                        <input type="text" class="form-control" id="search" placeholder="Поиск..." />
                    </div>

                    <!-- Кнопка для применения фильтров (даты + исполнитель) на сервере -->
                    <button type="submit" class="btn btn-primary align-self-bottom">Применить</button>

                    <!-- Кнопка для выхода (очистка куки) -->
                    <a asp-page="./Index" asp-page-handler="Logout" class="btn btn-outline-danger align-self-end">Выход</a>
                </form>
            </div>
        </div>
    </div>

    <!-- Основная таблица работ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="table-responsive">
                @await Html.PartialAsync("_WorkItemsTablePartial", Model)
            </div>
        </div>
    </div>

    <!-- Таблица уведомлений (пример) -->
    <div class="row mb-4">
        <div class="col-12 col-lg-6">
            <div class="table-responsive">
                <table class="table table-striped align-middle">
                    <thead class="table-success">
                        <tr>
                            <th scope="col">Напоминание</th>
                            <th scope="col">Дата</th>
                            <th scope="col">Кому</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="3" class="text-muted">Нет уведомлений</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Кнопки внизу страницы -->
    <div class="row mb-4">
        <div class="col-12 d-flex gap-3">
            <button type="button" class="btn btn-success shadow-sm"
                    style="transition: transform 0.2s;"
                    onmousedown="this.style.transform='scale(0.95)'"
                    onmouseup="this.style.transform='scale(1)'"
                    onclick="showReportAndPrint()">
                Сформировать сдаточный чек
            </button>

            <form method="get">
                <button type="submit" class="btn btn-secondary shadow-sm"
                        style="transition: transform 0.2s;"
                        onmousedown="this.style.transform='scale(0.95)'"
                        onmouseup="this.style.transform='scale(1)'">
                    Обновить
                </button>
            </form>
        </div>
    </div>

    <!-- Скрытый блок для отчёта -->
    <div id="reportBlock" class="border p-3" style="display: none;">
        <h4>Сдаточный чек</h4>
        <p>Дата формирования: @DateTime.Now.ToString("dd.MM.yyyy HH:mm")</p>
        <p>
            Период:
            @if (Model.StartDate.HasValue && Model.EndDate.HasValue)
            {
                @($"{Model.StartDate.Value:dd.MM.yyyy} - {Model.EndDate.Value:dd.MM.yyyy}")
            }
            else
            {
                <text>не задан</text>
            }
        </p>

        <hr />

        <table class="table table-sm table-bordered">
            <thead>
                <tr>
                    <th>Документ</th>
                    <th>Работа</th>
                    <th>Исполнитель</th>
                    <th>План</th>
                    <th>Корр1</th>
                    <th>Корр2</th>
                    <th>Корр3</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.WorkItems)
                {
                    <tr>
                        <td>@item.DocumentName</td>
                        <td>@item.WorkName</td>
                        <td>@item.Executor</td>
                        <td>@item.PlanDate?.ToString("dd.MM.yyyy")</td>
                        <td>@item.Korrect1?.ToString("dd.MM.yyyy")</td>
                        <td>@item.Korrect2?.ToString("dd.MM.yyyy")</td>
                        <td>@item.Korrect3?.ToString("dd.MM.yyyy")</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script>
        // Обработчик изменения выпадающего списка с исполнителями
        document.getElementById('executor').addEventListener('change', function () {
            // Автоматически отправляем форму при изменении выбора
            document.getElementById('filterForm').submit();
        });

        // Обработчик для поиска (динамическая фильтрация на стороне клиента)
        document.getElementById('search').addEventListener('keyup', function () {
            var filter = this.value.toLowerCase();
            var rows = document.querySelectorAll('#worksTable tbody tr');
            rows.forEach(function (row) {
                var docText = row.cells[1].textContent.toLowerCase();
                var workText = row.cells[2].textContent.toLowerCase();
                if (docText.indexOf(filter) > -1 || workText.indexOf(filter) > -1) {
                    row.style.display = "";
                } else {
                    row.style.display = "none";
                }
            });
        });

        // Обработчик для отображения отчёта
        function showReportAndPrint() {
            var reportBlock = document.getElementById('reportBlock');
            reportBlock.style.display = 'block';
            window.print();
        }
    </script>
}