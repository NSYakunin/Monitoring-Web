@page
@using Monitoring.UI.Pages
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@model             IndexModel
@{
    ViewData["Title"] = "Главная страница";
    Layout = "_Layout.cshtml";
}

<!-- Подключаем стили -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

<div class="container-fluid mt-4">
    <!-- Шапка: подразделение, пользователь, фильтры -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex flex-wrap align-items-center justify-content-between bg-light p-3 rounded">
                <div>
                    <h5 class="mb-0">Подразделение: @Model.DepartmentName</h5>
                    <p class="text-muted mb-0">Текущий пользователь: @Model.UserName</p>
                </div>
                <!-- Форма с фильтрами (скрытая кнопка "Применить" мы убираем) -->
                <form method="get" id="filterForm" class="d-flex flex-wrap align-items-end gap-2">
                    <!-- Фильтр по датам (при необходимости тоже можно сделать автообновление) -->
                    <div class="d-flex flex-column">
                        <label for="startDate" class="form-label">C даты:</label>
                        <input type="date" class="form-control" id="startDate" name="StartDate" 
                               value="@(Model.StartDate?.ToString("yyyy-MM-dd") ?? "")" />
                    </div>
                    <div class="d-flex flex-column">
                        <label for="endDate" class="form-label">По дату:</label>
                        <input type="date" class="form-control" id="endDate" name="EndDate" 
                               value="@(Model.EndDate?.ToString("yyyy-MM-dd") ?? "")" />
                    </div>
                    <!-- Выпадающий список для выбора исполнителя -->
                    <div class="d-flex flex-column">
                        <label for="executor" class="form-label">Исполнитель:</label>
                        <select id="executor" name="executor" class="form-select">
                            <option value="">Все исполнители</option>
                            @foreach (var item in Model.Executors)
                            {
                                <option value="@item.Value"
                                        selected="@(item.Value == Model.Executor ? "selected" : null)">
                                    @item.Text
                                </option>
                            }
                        </select>
                    </div>
                    <!-- Поле поиска -->
                    <div class="d-flex flex-column">
                        <label for="search" class="form-label">Поиск:</label>
                        <input type="text" class="form-control" id="search" name="search" placeholder="Поиск..." 
                               value="@Model.SearchQuery" />
                    </div>
                    <!-- Кнопка выхода (Logout) -->
                    <a asp-page="./Index" asp-page-handler="Logout" class="btn btn-outline-danger">Выход</a>
                </form>
            </div>
        </div>
    </div>

    <form method="post" class="position-relative">
        <!-- Скрытые поля, чтобы фильтры передавались при POST -->
        <input type="hidden" asp-for="StartDate" />
        <input type="hidden" asp-for="EndDate" />
        <input type="hidden" asp-for="Executor" />
        <input type="hidden" asp-for="SearchQuery" />

        <button type="submit" class="btn btn-primary" id="generatePdfBtn">
            <span class="spinner-border spinner-border-sm me-2"
                  role="status" aria-hidden="true" style="display:none;"></span>
            Сгенерировать PDF
        </button>
    </form>

    <!-- Таблица работ (Partial view) -->
    <div class="row mb-4">
        <div class="col-12">
            <div id="workItemsTableContainer">
                @await Html.PartialAsync("_WorkItemsTablePartial", Model)
            </div>
        </div>
    </div>
</div>



<!-- Скрипты: jQuery, Bootstrap, Handsontable -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>

@section Scripts {
    <style>
        /* Ограничиваем ширину таблицы и добавляем горизонтальную прокрутку */
        #spreadsheet {
            width: 100%;
            height: 80vh;
            overflow: auto;
            max-width: 100%;
        }

        .handsontable th,
        .handsontable td {
            min-width: 50px;
            max-width: 300px;
        }

        .handsontable {
            box-sizing: border-box;
        }

        .handsontable colHeader {
            position: sticky;
            top: 0;
            background-color: #f8f9fa; /* Цвет фона заголовков */
            z-index: 1;
        }
    </style>

    <script>
        $(document).ready(function(){
            // При изменении полей фильтра вызываем AJAX
            $('#startDate, #endDate, #executor, #search').on('change keyup', function(e) {
                $.ajax({
                    url: '@Url.Page("Index", "Filter")', // вызов OnGetFilterAsync
                    type: 'GET',
                    data: {
                        startDate: $('#startDate').val(),
                        endDate:   $('#endDate').val(),
                        executor:  $('#executor').val(),
                        searchQuery: $('#search').val()
                    },
                    success: function(result) {
                        // Подменяем только таблицу
                        $('#workItemsTableContainer').html(result);

                        // А также подставляем эти значения в скрытые поля,
                        // чтобы при нажатии "Сгенерировать PDF" они ушли в OnPost
                        $('input[name="StartDate"]').val($('#startDate').val());
                        $('input[name="EndDate"]').val($('#endDate').val());
                        $('input[name="Executor"]').val($('#executor').val());
                        $('input[name="SearchQuery"]').val($('#search').val());
                    }
                });
            });
        });
    </script>
}