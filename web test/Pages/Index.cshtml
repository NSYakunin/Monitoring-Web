@page
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@model web_test.Pages.IndexModel

@{
    ViewData["Title"] = "Главная страница";
    Layout = "_Layout.cshtml";
}

<!-- Стили для DataTables и плагинов -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/rowreorder/1.4.1/css/rowReorder.dataTables.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/select/1.7.0/css/select.dataTables.min.css">

<div class="container-fluid">
    <!-- Шапка: подразделение, пользователь, фильтры -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex flex-wrap align-items-center justify-content-between bg-light p-3 rounded">
                <div>
                    <h5 class="mb-0">Подразделение: @Model.DepartmentName</h5>
                    <p class="text-muted mb-0">Текущий пользователь: @Model.UserName</p>
                </div>

                <!-- Форма с фильтрами -->
                <form method="get" id="filterForm" class="d-flex flex-wrap align-items-end gap-2">
                    <!-- Фильтр по датам -->
                    <div class="d-flex flex-column">
                        <label for="startDate" class="form-label">C даты:</label>
                        <input type="date" class="form-control" id="startDate" name="StartDate"
                               value="@(Model.StartDate.HasValue ? Model.StartDate.Value.ToString("yyyy-MM-dd") : null)" />
                    </div>
                    <div class="d-flex flex-column">
                        <label for="endDate" class="form-label">по дату:</label>
                        <input type="date" class="form-control" id="endDate" name="EndDate"
                               value="@(Model.EndDate.HasValue ? Model.EndDate.Value.ToString("yyyy-MM-dd") : null)" />
                    </div>

                    <!-- Выпадающий список для выбора исполнителя -->
                    <div class="d-flex flex-column">
                        <label for="executor" class="form-label">Исполнитель:</label>
                        <select id="executor" name="executor" class="form-select">
                            <option value="">Все исполнители</option>
                            @foreach (var item in Model.Executors)
                            {
                                <option value="@item.Value" selected="@(item.Value == Model.executor)">@item.Value</option>
                            }
                        </select>
                    </div>

                    <!-- Строка поиска -->
                    <div class="d-flex flex-column">
                        <label for="search" class="form-label">Поиск:</label>
                        <input type="text" class="form-control" id="search" placeholder="Поиск..." />
                    </div>

                    <!-- Кнопка для применения фильтров (даты + исполнитель) на сервере -->
                    <button type="submit" class="btn btn-primary align-self-bottom">Применить</button>

                    <!-- Кнопка для выхода (очистка куки) -->
                    <a asp-page="./Index" asp-page-handler="Logout" class="btn btn-outline-danger align-self-end">Выход</a>
                </form>
            </div>
        </div>
    </div>

    <!-- Основная таблица работ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="table-responsive">
                @await Html.PartialAsync("_WorkItemsTablePartial", Model)
            </div>
        </div>
    </div>

    <!-- Таблица уведомлений (пример) -->
    <div class="row mb-4">
        <div class="col-12 col-lg-6">
            <div class="table-responsive">
                <table class="table table-striped align-middle">
                    <thead class="table-success">
                        <tr>
                            <th scope="col">Напоминание</th>
                            <th scope="col">Дата</th>
                            <th scope="col">Кому</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="3" class="text-muted">Нет уведомлений</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Кнопки внизу страницы -->
    <div class="row mb-4">
        <div class="col-12 d-flex gap-3">
            <button type="button" class="btn btn-success shadow-sm"
                    style="transition: transform 0.2s;"
                    onmousedown="this.style.transform='scale(0.95)'"
                    onmouseup="this.style.transform='scale(1)'"
                    onclick="showReportAndPrint()">
                Сформировать сдаточный чек
            </button>

            <form method="get">
                <button type="submit" class="btn btn-secondary shadow-sm"
                        style="transition: transform 0.2s;"
                        onmousedown="this.style.transform='scale(0.95)'"
                        onmouseup="this.style.transform='scale(1)'">
                    Обновить
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Скрипты -->
<script src="https://code.jquery.com/jquery-3.7.0.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/rowreorder/1.4.1/js/dataTables.rowReorder.min.js"></script>
<script src="https://cdn.datatables.net/select/1.7.0/js/dataTables.select.min.js"></script>

@section Scripts {
    <style>
        /* Стиль выделения строк */
        .dataTables_wrapper .selected {
            background-color: rgba(224, 247, 250, 0.5) !important;
        }

        /* Ширина колонок при печати */
        @@media print {
            .print-table th:nth-child(2), .print-table td:nth-child(3)

        {
            width: 40% !important;
        }

        }
    </style>

    <script>
        $(document).ready(function () {
            // Инициализация DataTables
            var table = $('#worksTable').DataTable({
         
                dom: 'Bfrtip', // Убираем стандартный поиск
                buttons: [{
                    extend: 'print',
                    text: 'Печать',
                    customize: function (win) {
                        $(win.document.body).prepend(
                            '<h3 style="text-align:right;">Отчет по работам</h3>' +
                            '<p style="text-align:right;">Дата: ' + new Date().toLocaleDateString() + '</p>'
                        );
                        $(win.document.body).find('table').addClass('print-table');
                    }
                }],
                columnDefs: [
                    {
                        type: 'date-eu', // Формат даты DD.MM.YYYY
                        targets: [6, 7, 8, 9, 10] // Колонки с датами
                    },
                    {
                        orderable: false,
                        targets: [1, 2] // Колонка "№" не сортируется
                    }
                ],
                rowReorder: true, // Включить перетаскивание строк
                select: {
                    style: 'multi',
                    selector: 'td:not(:first-child)'
                },
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/ru.json' // Русский язык
                },
                paging: false,
                stateSave: true
            });

            // Поиск через ваше поле
            $('#search').on('keyup', function () {
                table.search(this.value).draw();
            });

            // Отправка формы при выборе исполнителя
            $('#executor').on('change', function () {
                $('#filterForm').submit();
            });
        });
    </script>
}