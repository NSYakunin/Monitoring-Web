@page
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@model web_test.Pages.IndexModel

@{
    ViewData["Title"] = "Главная страница";
    Layout = "_Layout.cshtml"; // Указываем макет, где должен быть RenderSection("Scripts", false)
}

<div class="container-fluid">

    <!-- Шапка: подразделение, пользователь, фильтры -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex flex-wrap align-items-center justify-content-between bg-light p-3 rounded">
                <div>
                    <h5 class="mb-0">Подразделение: @Model.DepartmentName</h5>
                    <p class="text-muted mb-0">Текущий пользователь: @Model.UserName</p>
                </div>

                <!-- Форма с фильтрами, отправляется методом GET -->
                <form method="get" class="d-flex flex-wrap align-items-end gap-2">

                    <!-- Поля выбора дат -->
                    <div class="d-flex flex-column">
                        <label for="startDate" class="form-label">C даты:</label>
                        <input type="date"
                               class="form-control"
                               id="startDate"
                               name="StartDate"
                               value="@(Model.StartDate.HasValue ? Model.StartDate.Value.ToString("yyyy-MM-dd") : null)" />
                    </div>
                    <div class="d-flex flex-column">
                        <label for="endDate" class="form-label">по дату:</label>
                        <input type="date"
                               class="form-control"
                               id="endDate"
                               name="EndDate"
                               value="@(Model.EndDate.HasValue ? Model.EndDate.Value.ToString("yyyy-MM-dd") : null)" />
                    </div>

                    <!-- Выпадающий список для выбора исполнителя -->
                    <div class="d-flex flex-column">
                        <label for="executor" class="form-label">Исполнитель:</label>
                        <select id="executor" name="executor" class="form-select">
                            <option value="">Все исполнители</option>
                            @* 
                              Перебираем Model.Executors и добавляем опции. 
                              Проверяем, совпадает ли значение с выбранным (Model.executor),
                              чтобы по возвращении из запроса сохранить выбранный пункт 
                            *@
                            @foreach (var item in Model.Executors)
                            {
                                <option value="@item.Value">
                                    @item.Text
                                </option>
                            }
                        </select>
                    </div>

                    <!-- Строка поиска для DocumentName и WorkName (клиентская фильтрация) -->
                    <div class="d-flex flex-column">
                        <label for="search" class="form-label">Поиск:</label>
                        <input type="text"
                               class="form-control"
                               id="search"
                               placeholder="Поиск по документу/работе..." />
                    </div>

                    <!-- Кнопка "Применить" отправляет форму на сервер для фильтрации по датам/исполнителю -->
                    <button type="submit" class="btn btn-primary align-self-bottom">Применить</button>

                    <!-- Кнопка "Выход" с обработчиком OnGetLogout -->
                    <a asp-page="./Index" asp-page-handler="Logout" class="btn btn-outline-danger align-self-end">Выход</a>
                </form>
            </div>
        </div>
    </div>

    <!-- Основная таблица работ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="table-responsive">
                <table class="table table-bordered table-hover align-middle text-center" id="worksTable">
                    <thead class="table-dark">
                        <tr>
                            <th scope="col">№</th>
                            <th scope="col">Наименование документа</th>
                            <th scope="col">Наименование работы</th>
                            <th scope="col">Исполнители</th>
                            <th scope="col">Контролирующий</th>
                            <th scope="col">Принимающий</th>
                            <th scope="col">План</th>
                            <th scope="col">Корр1</th>
                            <th scope="col">Корр2</th>
                            <th scope="col">Корр3</th>
                            <th scope="col">Факт</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.WorkItems == null || Model.WorkItems.Count == 0)
                        {
                            <tr>
                                <td colspan="11" class="text-muted">Нет данных</td>
                            </tr>
                        }
                        else
                        {
                            int index = 1;
                            foreach (var item in Model.WorkItems)
                            {
                                <tr>
                                    <td>@index</td>
                                    <td>@item.DocumentName</td>
                                    <td>@item.WorkName</td>
                                    <!-- Здесь выводим всех исполнителей в одной ячейке, разделяя запятой -->
                                    <td>@item.Executor</td>
                                    <td>@item.Controller</td>
                                    <td>@item.Approver</td>
                                    <td>@item.PlanDate?.ToString("dd.MM.yyyy")</td>
                                    <td>@item.Korrect1?.ToString("dd.MM.yyyy")</td>
                                    <td>@item.Korrect2?.ToString("dd.MM.yyyy")</td>
                                    <td>@item.Korrect3?.ToString("dd.MM.yyyy")</td>
                                    <td>@item.FactDate?.ToString("dd.MM.yyyy")</td>
                                </tr>
                                index++;
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Пример второй таблицы (уведомления, если нужно) -->
    <div class="row mb-4">
        <div class="col-12 col-lg-6">
            <div class="table-responsive">
                <table class="table table-striped align-middle">
                    <thead class="table-success">
                        <tr>
                            <th scope="col">Напоминание</th>
                            <th scope="col">Дата</th>
                            <th scope="col">Кому</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="3" class="text-muted">Нет уведомлений</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Кнопки внизу страницы (пример) -->
    <div class="row mb-4">
        <div class="col-12 d-flex gap-3">
            <button type="button" class="btn btn-success shadow-sm"
                    style="transition: transform 0.2s;"
                    onmousedown="this.style.transform='scale(0.95)'"
                    onmouseup="this.style.transform='scale(1)'"
                    onclick="showReportAndPrint()">
                Сформировать сдаточный чек
            </button>

            <form method="get">
                <button type="submit" class="btn btn-secondary shadow-sm"
                        style="transition: transform 0.2s;"
                        onmousedown="this.style.transform='scale(0.95)'"
                        onmouseup="this.style.transform='scale(1)'">
                    Обновить
                </button>
            </form>
        </div>
    </div>

    <!-- Скрытый блок для отчёта (по необходимости) -->
    <div id="reportBlock" class="border p-3" style="display: none;">
        <h4>Сдаточный чек</h4>
        <p>Дата формирования: @DateTime.Now.ToString("dd.MM.yyyy HH:mm")</p>
        <p>
            Период:
            @if (Model.StartDate.HasValue && Model.EndDate.HasValue)
            {
                @($"{Model.StartDate.Value:dd.MM.yyyy} - {Model.EndDate.Value:dd.MM.yyyy}")
            }
            else
            {
                <text>не задан</text>
            }
        </p>

        <hr />

        <table class="table table-sm table-bordered">
            <thead>
                <tr>
                    <th>Документ</th>
                    <th>Работа</th>
                    <th>Исполнитель</th>
                    <th>Плановая дата</th>
                    <th>Корректировка 1</th>
                    <th>Корректировка 2</th>
                    <th>Корректировка 3</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.WorkItems)
                {
                    <tr>
                        <td>@item.DocumentName</td>
                        <td>@item.WorkName</td>
                        <td>@item.Executor</td>
                        <td>@item.PlanDate?.ToString("dd.MM.yyyy")</td>
                        <td>@item.Korrect1?.ToString("dd.MM.yyyy")</td>
                        <td>@item.Korrect2?.ToString("dd.MM.yyyy")</td>
                        <td>@item.Korrect3?.ToString("dd.MM.yyyy")</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

</div> <!-- /container-fluid -->

<!-- Скрипты -->
@section Scripts {
    <script>
        // Функция показа блока отчёта и отправки на печать (пример)
        function showReportAndPrint() {
            const block = document.getElementById('reportBlock');
            block.style.display = 'block';
            window.print();
        }

        // Скрипт для динамического поиска по таблице worksTable (по DocumentName и WorkName)
        // Реагируем на ввод текста в поле #search
        document.getElementById('search').addEventListener('keyup', function () {
            var filter = this.value.toLowerCase();
            var rows = document.querySelectorAll('#worksTable tbody tr');
            rows.forEach(function (row) {
                // Индекс 1 в таблице - "Наименование документа", индекс 2 - "Наименование работы"
                var docText = row.cells[1].textContent.toLowerCase();
                var workText = row.cells[2].textContent.toLowerCase();

                // Если строка содержит введённый текст в любом из этих столбцов - показываем, иначе скрываем
                if (docText.indexOf(filter) > -1 || workText.indexOf(filter) > -1) {
                    row.style.display = "";
                } else {
                    row.style.display = "none";
                }
            });
        });
    </script>
}